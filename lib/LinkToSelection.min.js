// Copyright (C) 2016-2017 Igor Afanasyev, https://github.com/iafan/LinkToSelection
// Version: 0.3

!function(){function t(){var t;if(window.getSelection&&(t=window.getSelection()).rangeCount)return t.getRangeAt(0)}function e(t){return t.nodeType===Node.TEXT_NODE?f:t.nodeName.toLowerCase()}function n(t){var o=e(t);if("body"===o)return"";if(t.id)return h+t.id.replace(/\-/g,m);var r,i=-1;if(t.parentNode){for(var a=t.parentNode.childNodes,d=0;d<a.length&&(e(a[d])!==o||(i++,a[d]!==t));d++);r=n(t.parentNode)}var s=i>0?o+p+i:o;return r?r+g+s:s}function o(t,e){return 0==e?t:t+w+e}function r(t){var e=t.indexOf(g);return-1==e?[t,void 0]:[t.substr(0,e),t.substr(e+g.length)]}function i(){var e=t();if(e){var r=e.startContainer===e.endContainer;if(!r||e.startOffset!==e.endOffset){var i=n(e.startContainer),a=r?u:n(e.endContainer),d=o(i,e.startOffset)+v+o(a,e.endOffset),s=c+btoa(d).replace(/=/g,"");document.location.hash!="#"+s&&(document.location.hash=s)}}}function a(t,n){if(!n)return t;var o=r(n),i=o[0].split(p),d=i[0],s=i[1]||0;if(d.startsWith(h)){var l=d.substr(h.length).replace(b,"-"),c=document.getElementById(l);if(!c)throw new Error("Can't find node with id '"+l+"'");return a(c,o[1])}for(var u=t.childNodes,f=-1,g=0;g<u.length;g++)if(e(u[g])===d&&++f==s)return a(u[g],o[1]);throw new Error("Can't find node <"+d+"> with index "+s+" in "+t)}function d(t){var e=t.split(v),n=e[0].split(w),o=e[1].split(w),r=a(document.body,n[0]),i=o[0]==u?r:a(document.body,o[0]),d=n[1]||0,l=o[1]||0,c=document.createRange();c.setStart(r,d),c.setEnd(i,l);var f=window.getSelection();if(f.removeAllRanges(),f.addRange(c),/\bAppleWebKit\b/.test(navigator.userAgent)&&/\biPad|iPhone|iPod\b/.test(navigator.userAgent)){for(var h=c.getClientRects(),g=0;g<h.length;g++){var p=document.createElement("div");p.style.zIndex="16777271",p.style.backgroundColor="Highlight",p.style.opacity="0.5",p.style.position="absolute",p.style.left=h[g].left+"px",p.style.top=h[g].top+"px",p.style.width=h[g].width+"px",p.style.height=h[g].height+"px",document.body.appendChild(p),p.ontouchstart=s,S.push(p)}x=!0}setTimeout(function(){var t=c.getBoundingClientRect(),e=window.scrollX||document.documentElement.scrollLeft,n=window.scrollY||document.documentElement.scrollTop,o=Math.round(t.left+e-C),r=Math.round(t.top+n-y);window.scrollTo(o,r),setTimeout(function(){window.scrollTo(o,r)},T)},0)}function s(t){if(console.log("onSelectionChange()"),clearTimeout(l),l=setTimeout(i,E),x&&S.length>0){for(var e=0;e<S.length;e++)document.body.removeChild(S[e]);S=[]}}var l,c="sel:",u="*",f="@",h="#",g="/",p=".",w=":",v="-",m="~",b=new RegExp(m,"g"),y=100,C=50,E=500,T=500,x=!1,S=[];String.prototype.startsWith||(String.prototype.startsWith=function(t){return 0==this.indexOf(t)}),window.getSelection?window.addEventListener("DOMContentLoaded",function(){var t=document.location.hash.substr(1);if(t.startsWith(c)){t=t.substr(c.length);try{d(atob(t))}catch(t){console.warn("Failed to recreate selection: ",t)}}setTimeout(function(){void 0!==document.onselectionchange?document.addEventListener("selectionchange",s):setInterval(i,E)},0)}):console.warn("window.getSelection is not supported in this browser")}();