// Copyright (C) 2016 Igor Afanasyev, https://github.com/iafan/LinkToSelection
// Version: 0.1

!function(){function t(){var t;return window.getSelection&&(t=window.getSelection(),t.rangeCount)?t.getRangeAt(0):void 0}function e(t){return t.nodeType===Node.TEXT_NODE?h:t.nodeName.toLowerCase()}function n(t){var o=e(t);if("body"===o)return"";if(t.id)return m+t.id.replace(/\-/g,T);var r,i=-1;if(t.parentNode){for(var a=t.parentNode.childNodes,d=0;d<a.length&&(e(a[d])!==o||(i++,a[d]!==t));d++);r=n(t.parentNode)}var s=i>0?o+p+i:o;return r?r+v+s:s}function o(t,e){return 0==e?t:t+b+e}function r(t){var e=t.indexOf(v);return-1==e?[t,void 0]:[t.substr(0,e),t.substr(e+v.length)]}function i(){var e=t();if(e){var r=e.startContainer===e.endContainer;if(!r||e.startOffset!==e.endOffset){var i=n(e.startContainer),a=r?g:n(e.endContainer),d=o(i,e.startOffset)+y+o(a,e.endOffset),s=w+btoa(d).replace(/=/g,"");document.location.hash!="#"+s&&(document.location.hash=s)}}}function a(t,n){if(!n)return t;var o=r(n),i=o[0].split(p),d=i[0],s=i[1]||0;if(d.startsWith(m)){var c=d.substr(m.length).replace(C,"-"),u=document.getElementById(c);if(!u)throw new Error("Can't find node with id '"+c+"'");return a(u,o[1])}for(var l=t.childNodes,f=-1,w=0;w<l.length;w++)if(e(l[w])===d&&(f++,f==s))return a(l[w],o[1]);throw new Error("Can't find node <"+d+"> with index "+s+" in "+t)}function d(t){var e=t.split(y),n=e[0].split(b),o=e[1].split(b),r=a(document.body,n[0]),i=o[0]==g?r:a(document.body,o[0]),d=n[1]||0,s=o[1]||0,c=document.createRange();c.setStart(r,d),c.setEnd(i,s);var u=window.getSelection();u.removeAllRanges(),u.addRange(c),setTimeout(function(){var t=c.getBoundingClientRect(),e=window.scrollX||document.documentElement.scrollLeft,n=window.scrollY||document.documentElement.scrollTop,o=Math.round(t.left+e-N),r=Math.round(t.top+n-E);window.scrollTo(o,r),setTimeout(function(){window.scrollTo(o,r)},O)},0)}function s(t){clearTimeout(u),u=setTimeout(i,S),l&&l(t)}function c(){var t=document.location.hash.substr(1);if(t.startsWith(w)){t=t.substr(w.length);try{d(atob(t))}catch(e){console.warn("Failed to recreate selection: ",e)}}}var u,l,f,w="sel:",g="*",h="@",m="#",v="/",p=".",b=":",y="-",T="~",C=new RegExp(T,"g"),E=100,N=50,S=500,O=500;if(String.prototype.startsWith||(String.prototype.startsWith=function(t){return 0==this.indexOf(t)},f=!0),window.getSelection){l=document.onselectionchange,document.onselectionchange=s;var R;(R=navigator.userAgent.match(/Firefox\/(\d+)/))&&R[1]<45&&(f=!0),f&&setInterval(i,S),"undefined"==typeof jQuery?window.onload=c:$(document).ready(c)}else console.warn("window.getSelection is not supported in this browser")}();