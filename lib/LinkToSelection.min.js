// Copyright (C) 2016 Igor Afanasyev, https://github.com/iafan/LinkToSelection
// Version: 0.2

!function(){function t(){var t;return window.getSelection&&(t=window.getSelection(),t.rangeCount)?t.getRangeAt(0):void 0}function e(t){return t.nodeType===Node.TEXT_NODE?w:t.nodeName.toLowerCase()}function n(t){var o=e(t);if("body"===o)return"";if(t.id)return h+t.id.replace(/\-/g,b);var r,i=-1;if(t.parentNode){for(var a=t.parentNode.childNodes,d=0;d<a.length&&(e(a[d])!==o||(i++,a[d]!==t));d++);r=n(t.parentNode)}var s=i>0?o+v+i:o;return r?r+g+s:s}function o(t,e){return 0==e?t:t+m+e}function r(t){var e=t.indexOf(g);return-1==e?[t,void 0]:[t.substr(0,e),t.substr(e+g.length)]}function i(){var e=t();if(e){var r=e.startContainer===e.endContainer;if(!r||e.startOffset!==e.endOffset){var i=n(e.startContainer),a=r?f:n(e.endContainer),d=o(i,e.startOffset)+p+o(a,e.endOffset),s=l+btoa(d).replace(/=/g,"");document.location.hash!="#"+s&&(document.location.hash=s)}}}function a(t,n){if(!n)return t;var o=r(n),i=o[0].split(v),d=i[0],s=i[1]||0;if(d.startsWith(h)){var c=d.substr(h.length).replace(E,"-"),u=document.getElementById(c);if(!u)throw new Error("Can't find node with id '"+c+"'");return a(u,o[1])}for(var l=t.childNodes,f=-1,w=0;w<l.length;w++)if(e(l[w])===d&&(f++,f==s))return a(l[w],o[1]);throw new Error("Can't find node <"+d+"> with index "+s+" in "+t)}function d(t){var e=t.split(p),n=e[0].split(m),o=e[1].split(m),r=a(document.body,n[0]),i=o[0]==f?r:a(document.body,o[0]),d=n[1]||0,s=o[1]||0,c=document.createRange();c.setStart(r,d),c.setEnd(i,s);var u=window.getSelection();u.removeAllRanges(),u.addRange(c),setTimeout(function(){var t=c.getBoundingClientRect(),e=window.scrollX||document.documentElement.scrollLeft,n=window.scrollY||document.documentElement.scrollTop,o=Math.round(t.left+e-T),r=Math.round(t.top+n-C);window.scrollTo(o,r),setTimeout(function(){window.scrollTo(o,r)},N)},0)}function s(t){clearTimeout(u),u=setTimeout(i,y)}function c(){var t=document.location.hash.substr(1);if(t.startsWith(l)){t=t.substr(l.length);try{d(atob(t))}catch(e){console.warn("Failed to recreate selection: ",e)}}}var u,l="sel:",f="*",w="@",h="#",g="/",v=".",m=":",p="-",b="~",E=new RegExp(b,"g"),C=100,T=50,y=500,N=500;String.prototype.startsWith||(String.prototype.startsWith=function(t){return 0==this.indexOf(t)}),window.getSelection?("undefined"!=typeof document.onselectionchange?document.addEventListener("selectionchange",s):setInterval(i,y),window.addEventListener("DOMContentLoaded",c)):console.warn("window.getSelection is not supported in this browser")}();